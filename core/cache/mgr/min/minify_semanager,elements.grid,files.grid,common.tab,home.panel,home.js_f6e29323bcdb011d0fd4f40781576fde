var SEManager=function(config){config=config||{};SEManager.superclass.constructor.call(this,config);};Ext.extend(SEManager,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},view:{},connector_url:''});Ext.reg('SEManager',SEManager);var SEManager=new SEManager();;SEManager.grid.Elements=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{description}</p>')});if(!config.tbar){config.tbar=[{text:_('quick_create_'+config.type),handler:{xtype:'modx-window-quick-create-'+config.type,blankValues:true}}];}
config.tbar.push('->',{xtype:'modx-combo',name:'filter_category',id:'semanager-filter-category'+config.type,emptyText:_('semanager.elements.filter_by_category'),fields:['id','category'],displayField:'category',valueField:'id',width:250,pageSize:10,url:SEManager.config.connectorUrl,baseParams:{action:'elements/getcategorylist',type:config.type},listeners:{'select':{fn:this.filterByCategory,scope:this}}},'-',{xtype:'textfield',name:'filter_name',id:'semanager-filter-name-'+config.type,emptyText:_('semanager.elements.filter_by_name')+'...',listeners:{'change':{fn:this.filterByName,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:cmp});},scope:this}}},{xtype:'button',id:'semanager-filter-clear-'+config.type,text:_('filter_clear'),handler:this.clearFilter});this.cm=new Ext.grid.ColumnModel({columns:[this.exp,{header:_('id'),dataIndex:'id',width:15},{header:_('name'),dataIndex:(config.type=='template')?'templatename':'name',width:50,sortable:true,sortDir:'ASC'},{header:_('semanager.elements.file'),dataIndex:'static_file',sortable:false,editable:false},{header:_('semanager.elements.static'),dataIndex:'static',width:30,sortable:true,editable:true,renderer:this.renderDynField.createDelegate(this,[this],true)}],tools:[{id:'plus',qtip:_('expand_all'),handler:this.expandAll,scope:this},{id:'minus',hidden:true,qtip:_('collapse_all'),handler:this.collapseAll,scope:this}],getCellEditor:function(colIndex,rowIndex){var field=this.getDataIndex(colIndex);if(field=='static'){var o=MODx.load({xtype:'combo-boolean'});return new Ext.grid.GridEditor(o);}
return Ext.grid.ColumnModel.prototype.getCellEditor.call(this,colIndex,rowIndex);}});Ext.applyIf(config,{cm:this.cm,fields:['id','name','static','static_file','description','category','snippet','plugincode','templatename','content','disabled'],id:'semanager-grid-elements-'+config.type+'s',url:SEManager.config.connectorUrl,baseParams:{action:'elements/getlist',type:config.type},clicksToEdit:2,autosave:true,save_action:'elements/updatefromgrid',plugins:this.exp,autoHeight:true,paging:true,remoteSort:false,listeners:{'afterAutoSave':{fn:function(){this.refresh();},scope:this},'afterEdit':{fn:function(e){e.record.data.type=config.type;}}}});SEManager.grid.Elements.superclass.constructor.call(this,config);};Ext.extend(SEManager.grid.Elements,MODx.grid.Grid,{renderDynField:function(v,md,rec,ri,ci,s,g){var r=s.getAt(ri).data;var f,idx;var oz=v;var xtype=this.config.dynProperty;if(!r[xtype]||r[xtype]=='combo-boolean'){f=MODx.grid.Grid.prototype.rendYesNo;oz=f(v==1,md);}else if(r[xtype]==='datefield'){f=Ext.util.Format.dateRenderer('Y-m-d');oz=f(v);}else if(r[xtype]==='password'){f=this.rendPassword;oz=f(v,md);}else if(r[xtype].substr(0,5)=='combo'||r[xtype]=='list'||r[xtype].substr(0,9)=='modx-combo'){var cm=g.getColumnModel();var ed=cm.getCellEditor(ci,ri);var cb;if(!ed){r.xtype=r.xtype||'combo-boolean';cb=this.createCombo(r);ed=new Ext.grid.GridEditor(cb);cm.setEditor(ci,ed);}else if(ed&&ed.field&&ed.field.xtype=='modx-combo'){cb=ed.field;}
if(r[xtype]!='list'){f=Ext.util.Format.comboRenderer(ed.field);oz=f(v);}else if(cb){idx=cb.getStore().find(cb.valueField,v);rec=cb.getStore().getAt(idx);if(rec){oz=rec.get(cb.displayField);}else{oz=v;}}}
return Ext.util.Format.htmlEncode(oz);},onDirty:function(){console.log(this.config.panel);if(this.config.panel){Ext.getCmp(this.config.panel).fireEvent('fieldChange');}},filterByCategory:function(category,selected){this.getStore().baseParams.categoryfilter=selected.id;this.getBottomToolbar().changePage(1);this.refresh();},filterByName:function(tf,newValue){this.getStore().baseParams.namefilter=newValue||tf;this.getBottomToolbar().changePage(1);this.refresh();},clearFilter:function(){this.getStore().baseParams={action:'elements/getlist',type:this.config.type};Ext.getCmp('semanager-filter-category'+this.config.type).reset();Ext.getCmp('semanager-filter-name-'+this.config.type).reset();this.getBottomToolbar().changePage(1);this.refresh();},getMenu:function(){var m=[];m.push({text:_('quick_update_'+this.config.type),handler:this.updateElement});this.addContextMenuItem(m);},updateElement:function(btn,e){var r=this.menu.record;r.clearCache=1;var que=MODx.load({xtype:'modx-window-quick-update-'+this.config.type,record:r,grid:this,listeners:{'success':{fn:function(){this.refresh();},scope:this}}});que.reset();que.setValues(r);que.show(e.target);}});Ext.reg('semanager-grid-elements-chunks',SEManager.grid.Elements);Ext.reg('semanager-grid-elements-plugins',SEManager.grid.Elements);Ext.reg('semanager-grid-elements-snippets',SEManager.grid.Elements);Ext.reg('semanager-grid-elements-templates',SEManager.grid.Elements);;SEManager.grid.Files=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{description}</p>')});if(!config.tbar){config.tbar=[{xtype:'button',text:_('semanager.common.actions.fromfiles'),icon:MODx.config.template_url+'images/restyle/icons/elements.png',cls:'x-btn-text-icon',style:{paddingLeft:'5px',float:'left',marginRight:'20px'},listeners:{click:function(){}},handler:this.makeElements}];}
config.tbar.push('->',{xtype:'modx-combo',name:'filter_type',id:'semanager-filter-type-files',emptyText:_('semanager.elements.filter_by_type'),fields:['id','type'],displayField:'type',valueField:'id',width:250,pageSize:10,url:SEManager.config.connectorUrl,baseParams:{action:'files/gettypelist.class',type:config.type},listeners:{'select':{fn:this.filterByType,scope:this}}},'-',{xtype:'textfield',name:'filter_name',id:'semanager-filter-name-files',emptyText:_('semanager.elements.filter_by_name')+'...',listeners:{'change':{fn:this.filterByName,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:cmp});},scope:this}}},{xtype:'button',id:'semanager-filter-clear-files',text:_('filter_clear'),handler:this.clearFilter});this.cm=new Ext.grid.ColumnModel({columns:[this.exp,{header:_('name'),dataIndex:'filename',width:30,sortable:false},{header:_('category'),dataIndex:'category',width:30,sortable:false,renderer:this.categoryRender},{header:_('type'),dataIndex:'type',width:30,sortable:false,editable:false,renderer:this.typeRender},{header:_('path'),dataIndex:'path',sortable:false,editable:false}],tools:[{id:'plus',qtip:_('expand_all'),handler:this.expandAll,scope:this},{id:'minus',hidden:true,qtip:_('collapse_all'),handler:this.collapseAll,scope:this}],getCellEditor:function(colIndex,rowIndex){var field=this.getDataIndex(colIndex);if(field=='static'){var rec=config.store.getAt(rowIndex);var o=MODx.load({xtype:'combo-boolean'});return new Ext.grid.GridEditor(o);}
return Ext.grid.ColumnModel.prototype.getCellEditor.call(this,colIndex,rowIndex);}});Ext.applyIf(config,{cm:this.cm,fields:['filename','category','type','path','content'],id:'semanager-grid-elements-files',url:SEManager.config.connectorUrl,baseParams:{action:'files/getlist'},clicksToEdit:2,autosave:true,save_action:'files/updatefromgrid',plugins:this.exp,autoHeight:true,paging:true,remoteSort:true,listeners:{'afterAutoSave':{fn:function(){this.refresh();},scope:this},'afterEdit':{fn:function(e){e.record.data.type=config.type;}}}});SEManager.grid.Files.superclass.constructor.call(this,config);};Ext.extend(SEManager.grid.Files,MODx.grid.Grid,{typeRender:function(r){if(r==0){return'no_type';}
return r;},categoryRender:function(r){if(r==0){return _('no_category');}
return r;},onDirty:function(){console.log(this.config.panel);if(this.config.panel){Ext.getCmp(this.config.panel).fireEvent('fieldChange');}},filterByType:function(type,selected){this.getStore().baseParams={action:'files/getlist',type:selected.id};this.getBottomToolbar().changePage(1);this.refresh();},filterByName:function(tf,newValue){this.getStore().baseParams.namefilter=newValue||tf;this.getBottomToolbar().changePage(1);this.refresh();},updateGrid:function(){alert(123);this.getBottomToolbar().changePage(1);this.refresh();},clearFilter:function(){this.getStore().baseParams={action:'files/getlist'};this.getBottomToolbar().changePage(1);this.refresh();},getMenu:function(r){var m=[];m.push({text:_('semanager.common.actions.fromfile'),handler:this.makeElement});m.push({text:_('semanager.common.actions.quickupdatefile'),handler:this.updatefile});m.push({text:_('semanager.common.actions.deletefile'),handler:this.deleteFiles});this.addContextMenuItem(m);},deleteFiles:function(btn,e){MODx.msg.confirm({title:_('semanager.common.actions.delete'),text:_('semanager.common.actions.deletefileq'),url:this.config.url,params:{action:'files/delete.class',path:this.menu.record.path},listeners:{'success':{fn:function(){this.refresh();},scope:this}}});},updatefile:function(btn,e){var r=this.menu.record;r.name=r.filename;r.source='0';r.file=r.path;r.clearCache=1;var que=MODx.load({xtype:'modx-window-file-quick-update',url:this.config.url,record:r,grid:this,action:'files/updatefiles.class',listeners:{'success':{fn:function(){this.refresh();},scope:this}}});que.reset();que.setValues(r);que.show(e.target);},makeElement:function(btn,e){MODx.msg.confirm({title:_('semanager.common.actions.create.element'),text:_('semanager.common.actions.create.element.confirm'),url:this.config.url,params:{action:'files/makeelement.class',path:this.menu.record.path,category:this.menu.record.category},listeners:{'success':{fn:function(){this.refresh();},scope:this}}});},makeElements:function(btn,e){Ext.Msg.show({title:_('please_wait'),msg:('Создание элементов из файлов'),width:240,progress:true,closable:false});MODx.util.Progress.reset();for(var i=1;i<20;i++){setTimeout('MODx.util.Progress.time('+i+','+MODx.util.Progress.id+')',i*1000);}
MODx.Ajax.request({url:SEManager.config.connectorUrl,params:{action:'files/newelem.class'},listeners:{'success':{fn:function(r){MODx.util.Progress.reset();Ext.Msg.hide();this.refresh();},scope:this},'failure':{fn:function(r){MODx.util.Progress.reset();Ext.Msg.hide();return false;},scope:this}}});}});Ext.reg('semanager-grid-files',SEManager.grid.Files);;SEManager.panel.CommonTab=function(config){config=config||{};Ext.applyIf(config,{id:'semanager-tab-common',bodyCssClass:'panel-desc',border:false,html:'<p>Категории элементов, которые следует исключать при отображении, обновлении, синхронизации.</p>'});SEManager.panel.CommonTab.superclass.constructor.call(this,config);};Ext.extend(SEManager.panel.CommonTab,MODx.Panel);Ext.reg('semanager-tab-common',SEManager.panel.CommonTab);;SEManager.panel.Home=function(config){config=config||{};Ext.apply(config,{border:false,baseCls:'modx-formpanel',cls:'container form-with-labels',items:[{html:'<h2>'+_('semanager.title')+' <sup style="font-size: 0.5em">'+_('semanager.description')+'</sup></h2>',border:false,cls:'modx-page-header'},{xtype:'modx-tabs',defaults:{autoHeight:true,hideMode:'offsets',border:true},stateful:true,stateId:'semanager-tabpanel-home',stateEvents:['tabchange'],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())};},items:[{title:_('semanager.tabs.actions'),id:'semanager-tab-actions',layout:'form',items:[{border:false,bodyCssClass:'panel-desc',items:[{xtype:'button',text:_('semanager.common.actions.allsync'),icon:MODx.config.template_url+'images/restyle/icons/refresh.png',cls:'x-btn-text-icon',style:{paddingLeft:'5px',float:'left',marginRight:'20px'},listeners:{click:function(){Ext.Msg.show({title:_('please_wait'),msg:('Синхронизация'),width:240,progress:true,closable:false});MODx.util.Progress.reset();for(var i=1;i<20;i++){setTimeout('MODx.util.Progress.time('+i+','+MODx.util.Progress.id+')',i*1000);}
MODx.Ajax.request({url:SEManager.config.connectorUrl,params:{action:'common/syncall',root:'111111'},listeners:{'success':{fn:function(r){MODx.util.Progress.reset();Ext.Msg.hide();},scope:this},'failure':{fn:function(r){MODx.util.Progress.reset();Ext.Msg.hide();MODx.form.Handler.errorJSON(r);return false;},scope:this}}});}}},{html:'<p style="background-color: #F7F7F7;">'+_('semanager.sync.description')+'</p>',border:false,style:{lineHeight:'30px'}}]},{bodyCssClass:'main-wrapper',border:false,items:[{xtype:'semanager-grid-files'}]}]},{title:_('chunks'),id:'semanager-tab-chunks',layout:'form',items:[{html:'<p>'+_('chunks')+'</p>',border:false,bodyCssClass:'panel-desc'},{xtype:'semanager-grid-elements-chunks',preventSaveRefresh:true,cls:'main-wrapper',type:'chunk'}]},{title:_('plugins'),id:'semanager-tab-plugins',layout:'form',items:[{html:'<p>'+_('plugins')+'</p>',border:false,bodyCssClass:'panel-desc'},{xtype:'semanager-grid-elements-plugins',preventSaveRefresh:true,cls:'main-wrapper',type:'plugin'}]},{title:_('snippets'),id:'semanager-tab-snippets',layout:'form',items:[{html:'<p>'+_('snippets')+'</p>',border:false,bodyCssClass:'panel-desc'},{xtype:'semanager-grid-elements-snippets',preventSaveRefresh:true,cls:'main-wrapper',type:'snippet'}]},{title:_('templates'),id:'semanager-tab-templates',layout:'form',items:[{html:'<p>'+_('templates')+'</p>',border:false,bodyCssClass:'panel-desc'},{xtype:'semanager-grid-elements-templates',preventSaveRefresh:true,cls:'main-wrapper',type:'template'}]}]}]});SEManager.panel.Home.superclass.constructor.call(this,config);};Ext.extend(SEManager.panel.Home,MODx.Panel);Ext.reg('semanager-panel-home',SEManager.panel.Home);;SEManager.page.Home=function(config){config=config||{};Ext.applyIf(config,{components:[{xtype:'semanager-panel-home',renderTo:'semanager-panel-home-div'}]});SEManager.page.Home.superclass.constructor.call(this,config);};Ext.extend(SEManager.page.Home,MODx.Component);Ext.reg('semanager-page-home',SEManager.page.Home);